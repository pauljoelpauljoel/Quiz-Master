<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz | Quiz Master</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border: none;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1rem;
            padding: 0;
            z-index: 5;
            transition: transform 0.2s, background 0.2s;
        }

        .remove-btn:hover {
            transform: scale(1.1);
            background: #ff6b81;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            /* Center vertically */
        }

        .col {
            flex: 1;
        }

        .col-radio {
            flex: 0 0 auto;
            width: 40px;
            display: flex;
            justify-content: center;
        }

        .insert-btn {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #fff;
            width: 100%;
            margin-top: 15px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .insert-btn:hover {
            background: rgba(46, 204, 113, 0.4);
        }
    </style>
</head>

<body>
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>

    <div class="container">
        <div id="create-quiz" class="glass-card" style="width: 100%; max-width: 800px;">
            <h1 style="text-align: center; margin-bottom: 20px;">Create Your Quiz</h1>

            <div style="margin-bottom: 20px;">
                <label>Quiz Title</label>
                <input type="text" id="quiz-title" placeholder="e.g. Science Class Final" style="margin-bottom: 0;">
            </div>

            <div id="questions-container">
                <!-- Questions injected here -->
            </div>

            <button id="add-q-btn" class="btn" style="background: rgba(255,255,255,0.2);">+ Add Question</button>
            <br><br>
            <button id="start-custom-game-btn" class="btn">Start Live Quiz</button>
        </div>
    </div>

    <script src="js/theme.js"></script>
    <script>
        const socket = io();
        const container = document.getElementById('questions-container');
        let questionCount = 0;

        // Safety: Warn before leaving
        window.addEventListener('beforeunload', (e) => {
            if (questionCount > 0) { // Only warn if they have added questions
                e.preventDefault();
                e.returnValue = '';
            }
        });

        function updateQuestionNumbers() {
            const cards = document.querySelectorAll('.question-card');
            questionCount = 0; // Reset counter
            cards.forEach((card, index) => {
                questionCount++;
                const num = questionCount;

                // Update Title
                card.querySelector('h3').textContent = `Question ${num}`;

                // Update Radio Names
                const radios = card.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.name = `correct_${num}`;
                });
            });
        }

        function addQuestion(data = null, afterElement = null) {
            const div = document.createElement('div');
            div.className = 'question-card';
            // Use temporary ID for creation, but updateQuestionNumbers will fix it immediately
            const tempCount = document.querySelectorAll('.question-card').length + 1;

            const qText = data ? data.question.replace(/"/g, '&quot;') : '';
            const qImage = data ? data.image : '';
            const qTime = data ? data.time : 20;
            const qPoints = data ? data.points : 1;

            const opt0 = (data && data.options[0]) ? data.options[0].replace(/"/g, '&quot;') : '';
            const opt1 = (data && data.options[1]) ? data.options[1].replace(/"/g, '&quot;') : '';
            const opt2 = (data && data.options[2]) ? data.options[2].replace(/"/g, '&quot;') : '';
            const opt3 = (data && data.options[3]) ? data.options[3].replace(/"/g, '&quot;') : '';

            const ans = data ? data.answer : 0;

            div.innerHTML = `
                <button class="remove-btn" onclick="this.parentElement.remove(); updateQuestionNumbers();">X</button>
                <h3>Question ${tempCount}</h3>
                
                <label>Question Text</label>
                <input type="text" class="q-text" placeholder="e.g. What is 2+2?" value="${qText}" required>
                
                <label>Image URL (Optional)</label>
                <input type="text" class="q-image" placeholder="https://example.com/image.jpg" value="${qImage}">

                <div class="row">
                    <div class="col">
                        <label>Time (seconds)</label>
                        <input type="number" class="q-time" value="${qTime}" min="5">
                    </div>
                    <div class="col">
                        <label>Points</label>
                        <input type="number" class="q-points" value="${qPoints}" step="1" min="0">
                    </div>
                </div>

                <label>Options (Select the radio button for the correct answer)</label>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="0" ${ans === 0 ? 'checked' : ''}></div>
                    <div class="col"><input type="text" class="q-opt-0" placeholder="Option 1" value="${opt0}" required></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="1" ${ans === 1 ? 'checked' : ''}></div>
                    <div class="col"><input type="text" class="q-opt-1" placeholder="Option 2" value="${opt1}" required></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="2" ${ans === 2 ? 'checked' : ''}></div>
                    <div class="col"><input type="text" class="q-opt-2" placeholder="Option 3" value="${opt2}"></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="3" ${ans === 3 ? 'checked' : ''}></div>
                    <div class="col"><input type="text" class="q-opt-3" placeholder="Option 4" value="${opt3}"></div>
                </div>
                
                <button class="insert-btn" onclick="addQuestion(null, this.closest('.question-card'))">+ Insert New Question Below</button>
            `;
            if (afterElement) {
                container.insertBefore(div, afterElement.nextSibling);
            } else {
                container.appendChild(div);
            }
            updateQuestionNumbers();

            // Scroll to new question if it was manually added (not loaded from data)
            if (!data) {
                div.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Add first question by default
        document.getElementById('add-q-btn').addEventListener('click', () => addQuestion());

        // Init load
        (function init() {
            const params = new URLSearchParams(window.location.search);
            const editId = params.get('edit');
            if (editId) {
                const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');
                const quiz = history.find(q => q.id == editId);
                if (quiz) {
                    document.getElementById('quiz-title').value = quiz.title;
                    // Clear default
                    container.innerHTML = '';
                    quiz.questions.forEach(q => addQuestion(q));
                    document.getElementById('start-custom-game-btn').textContent = "Save Changes";
                } else {
                    // ID not found, maybe deleted? Just default to new.
                    addQuestion();
                }
            } else {
                addQuestion();
            }
        })();

        document.getElementById('start-custom-game-btn').addEventListener('click', () => {
            // Collect Data
            const cards = document.querySelectorAll('.question-card');
            const questions = [];
            let isValid = true;

            for (let card of cards) {
                const text = card.querySelector('.q-text').value;
                if (!text) continue; // Skip empty questions

                const image = card.querySelector('.q-image').value;
                const time = parseInt(card.querySelector('.q-time').value) || 20;
                const points = parseInt(card.querySelector('.q-points').value) || 1;

                // Get options
                const options = [];
                const opt0 = card.querySelector('.q-opt-0').value;
                const opt1 = card.querySelector('.q-opt-1').value;
                const opt2 = card.querySelector('.q-opt-2').value;
                const opt3 = card.querySelector('.q-opt-3').value;

                if (opt0) options.push(opt0);
                if (opt1) options.push(opt1);
                if (opt2) options.push(opt2);
                if (opt3) options.push(opt3);

                // Get correct answer index
                // Note: The UI has radio buttons 0-3. If user deleted option 3 but selected radio 3, that's invalid.
                // We need to map the selected radio value to the array index.
                const radioName = card.querySelector('input[type="radio"]').name;
                const selectedRadio = card.querySelector(`input[name="${radioName}"]:checked`);
                let correctIndex = selectedRadio ? parseInt(selectedRadio.value) : 0;

                // Validation: ensure options exist. 
                // Minimal 2 options
                if (options.length < 2) {
                    isValid = false;
                    alert("Each question needs at least 2 options!");
                    return;
                }

                questions.push({
                    question: text,
                    image: image,
                    options: options,
                    answer: correctIndex,
                    time: time,
                    points: points
                });
            }

            if (questions.length === 0) {
                isValid = false;
                alert("Add at least one question!");
                return;
            }

            if (isValid) {
                // Save to History
                const titleInput = document.getElementById('quiz-title');
                const title = (titleInput && titleInput.value.trim()) ? titleInput.value.trim() : `My Quiz ${new Date().toLocaleDateString()}`;

                const newQuiz = {
                    id: Date.now(),
                    title: title,
                    questions: questions,
                    date: new Date().toISOString()
                };

                const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');

                // Check if editing
                const params = new URLSearchParams(window.location.search);
                const editId = params.get('edit');

                if (editId) {
                    const index = history.findIndex(q => q.id == editId);
                    if (index !== -1) {
                        // Update existing
                        history[index].title = title;
                        history[index].questions = questions;
                    } else {
                        history.push(newQuiz);
                    }
                    localStorage.setItem('quizHistory', JSON.stringify(history));
                    // Redirect to history after edit
                    window.location.href = '/history.html';
                } else {
                    history.push(newQuiz);
                    localStorage.setItem('quizHistory', JSON.stringify(history));

                    // Set as active for immediate play
                    localStorage.setItem('customQuiz', JSON.stringify(questions));
                    window.location.href = '/host?custom=true';
                }
            }
        });

    </script>
</body>

```