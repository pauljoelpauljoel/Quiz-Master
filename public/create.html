<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz | Quiz Master</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            /* Center vertically */
        }

        .col {
            flex: 1;
        }

        .col-radio {
            flex: 0 0 auto;
            width: 40px;
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>

    <div class="container">
        <div id="create-quiz" class="glass-card" style="width: 100%; max-width: 800px;">
            <h1 style="text-align: center; margin-bottom: 20px;">Create Your Quiz</h1>

            <div style="margin-bottom: 20px;">
                <label>Quiz Title</label>
                <input type="text" id="quiz-title" placeholder="e.g. Science Class Final" style="margin-bottom: 0;">
            </div>

            <div id="questions-container">
                <!-- Questions injected here -->
            </div>

            <button id="add-q-btn" class="btn" style="background: rgba(255,255,255,0.2);">+ Add Question</button>
            <br><br>
            <button id="start-custom-game-btn" class="btn">Start Live Quiz</button>
        </div>
    </div>

    <script src="js/theme.js"></script>
    <script>
        const socket = io();
        const container = document.getElementById('questions-container');
        let questionCount = 0;

        // Safety: Warn before leaving
        window.addEventListener('beforeunload', (e) => {
            if (questionCount > 0) { // Only warn if they have added questions
                e.preventDefault();
                e.returnValue = '';
            }
        });

        function updateQuestionNumbers() {
            const cards = document.querySelectorAll('.question-card');
            questionCount = 0; // Reset counter
            cards.forEach((card, index) => {
                questionCount++;
                const num = questionCount;

                // Update Title
                card.querySelector('h3').textContent = `Question ${num}`;

                // Update Radio Names
                const radios = card.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.name = `correct_${num}`;
                });
            });
        }

        function addQuestion() {
            const div = document.createElement('div');
            div.className = 'question-card';
            // Use temporary ID for creation, but updateQuestionNumbers will fix it immediately
            const tempCount = document.querySelectorAll('.question-card').length + 1;

            div.innerHTML = `
                <button class="btn remove-btn" onclick="this.parentElement.remove(); updateQuestionNumbers();">X</button>
                <h3>Question ${tempCount}</h3>
                
                <label>Question Text</label>
                <input type="text" class="q-text" placeholder="e.g. What is 2+2?" required>
                
                <label>Image URL (Optional)</label>
                <input type="text" class="q-image" placeholder="https://example.com/image.jpg">

                <div class="row">
                    <div class="col">
                        <label>Time (seconds)</label>
                        <input type="number" class="q-time" value="20" min="5">
                    </div>
                    <div class="col">
                        <label>Points</label>
                        <input type="number" class="q-points" value="1" step="1" min="0">
                    </div>
                </div>

                <label>Options (Select the radio button for the correct answer)</label>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="0" checked></div>
                    <div class="col"><input type="text" class="q-opt-0" placeholder="Option 1" required></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="1"></div>
                    <div class="col"><input type="text" class="q-opt-1" placeholder="Option 2" required></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="2"></div>
                    <div class="col"><input type="text" class="q-opt-2" placeholder="Option 3"></div>
                </div>
                <div class="row">
                    <div class="col-radio"><input type="radio" name="correct_${tempCount}" value="3"></div>
                    <div class="col"><input type="text" class="q-opt-3" placeholder="Option 4"></div>
                </div>
            `;
            container.appendChild(div);
            updateQuestionNumbers();
        }

        // Add first question by default
        addQuestion();

        document.getElementById('add-q-btn').addEventListener('click', addQuestion);

        document.getElementById('start-custom-game-btn').addEventListener('click', () => {
            // Collect Data
            const cards = document.querySelectorAll('.question-card');
            const questions = [];
            let isValid = true;

            for (let card of cards) {
                const text = card.querySelector('.q-text').value;
                if (!text) continue; // Skip empty questions

                const image = card.querySelector('.q-image').value;
                const time = parseInt(card.querySelector('.q-time').value) || 20;
                const points = parseInt(card.querySelector('.q-points').value) || 1;

                // Get options
                const options = [];
                const opt0 = card.querySelector('.q-opt-0').value;
                const opt1 = card.querySelector('.q-opt-1').value;
                const opt2 = card.querySelector('.q-opt-2').value;
                const opt3 = card.querySelector('.q-opt-3').value;

                if (opt0) options.push(opt0);
                if (opt1) options.push(opt1);
                if (opt2) options.push(opt2);
                if (opt3) options.push(opt3);

                // Get correct answer index
                // Note: The UI has radio buttons 0-3. If user deleted option 3 but selected radio 3, that's invalid.
                // We need to map the selected radio value to the array index.
                const radioName = card.querySelector('input[type="radio"]').name;
                const selectedRadio = card.querySelector(`input[name="${radioName}"]:checked`);
                let correctIndex = selectedRadio ? parseInt(selectedRadio.value) : 0;

                // Validation: ensure options exist. 
                // Minimal 2 options
                if (options.length < 2) {
                    isValid = false;
                    alert("Each question needs at least 2 options!");
                    return;
                }

                questions.push({
                    question: text,
                    image: image,
                    options: options,
                    answer: correctIndex,
                    time: time,
                    points: points
                });
            }

            if (questions.length === 0) {
                isValid = false;
                alert("Add at least one question!");
                return;
            }

            if (isValid) {
                // Save to History
                const titleInput = document.getElementById('quiz-title');
                const title = (titleInput && titleInput.value.trim()) ? titleInput.value.trim() : `My Quiz ${new Date().toLocaleDateString()}`;

                const newQuiz = {
                    id: Date.now(),
                    title: title,
                    questions: questions,
                    date: new Date().toISOString()
                };

                const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');
                history.push(newQuiz);
                localStorage.setItem('quizHistory', JSON.stringify(history));

                // Set as active for immediate play
                localStorage.setItem('customQuiz', JSON.stringify(questions));
                window.location.href = '/host?custom=true';
            }
        });

    </script>
</body>

```